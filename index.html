<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GiÃ¡m Ä‘á»‹nh</title>
  <style>
    body { font-family: Helvetica, sans-serif; text-align: center; margin: 0; padding: 0; background: #f0f0f0; }
    h1 { margin: 20px; }
    .tabs { margin-top: 20px; }
    .tab-btn { padding: 10px 20px; margin: 5px; cursor: pointer; border: none; background: #ccc; border-radius: 5px; }
    .tab-btn.active { background: #666; color: white; }
    .tab-content { display: none; padding: 20px; }
    .tab-content.active { display: block; }
    .container { display: flex; justify-content: center; gap: 80px; margin-top: 30px; }
    .col { display: flex; flex-direction: column; gap: 20px; }
    .btn { font-size: 32px; font-weight: bold; padding: 20px; width: 200px; border: none; border-radius: 10px; cursor: pointer; transition: background 0.2s; }
    .btn.red { background: red; color: white; }
    .btn.blue { background: blue; color: white; }
    .status {
      height: 30px;           /* LuÃ´n chiáº¿m 30px chiá»u cao */
      font-size: 18px;
      color: green;
      margin-bottom: 10px;
      transition: opacity 0.3s ease;
      overflow: hidden;
      white-space: nowrap;
    }
    label, input { display: block; margin-bottom: 10px; }
    input { padding: 5px; width: 100%; }
    button.save-btn { 
      margin-top: 10px; 
      width: 100%; 
      padding: 16px;       /* tÄƒng kÃ­ch thÆ°á»›c vÃ¹ng báº¥m */
      font-size: 18px;     /* chá»¯ to hÆ¡n */
      font-weight: bold;   /* chá»¯ Ä‘áº­m hÆ¡n Ä‘á»ƒ dá»… tháº¥y */
      border-radius: 8px;  /* bo gÃ³c nháº¹ nhÃ ng hÆ¡n */
    }
    .setting-box { max-width: 300px; margin: 0 auto; text-align: left; }
    .number-grid {
      display: grid;
      grid-template-columns: repeat(3, 100px);
      gap: 15px;
      justify-content: center;
      margin: 30px auto;
    }
    .btn.number {
      font-size: 24px;
      padding: 20px;
      width: 100px;
      height: 80px;
      border-radius: 10px;
      font-weight: bold;
    }
    .btn.number.green {
      background: #4caf50;
      color: white;
    }
    .btn-large {
      font-size: 48px;
      padding: 30px;
      width: 260px;
    }
    .blink {
      background-color: yellow !important;
      color: black !important;
    }
    .number-pad-container {
      display: inline-block;
      border: 3px solid #4caf50;
      border-radius: 12px;
      padding: 20px;
      background: #ffffff;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      margin-top: 20px;
    }

    /* Cháº¿ Ä‘á»™ xoay ngang toÃ n trang */
    body.landscape-mode {
      transform: rotate(90deg);
      transform-origin: center center;
      width: 100vh;
      height: 100vw;
      position: fixed;
      top: 50%;
      left: 50%;
      margin-top: -50vw;
      margin-left: -50vh;
      overflow-x: hidden;
    }

    /* Äáº£m báº£o cÃ¡c tab váº«n hiá»ƒn thá»‹ Ä‘Ãºng */
    body.landscape-mode .tab-content {
      height: calc(100vh - 120px); /* Trá»« Ä‘i chiá»u cao header */
      overflow-y: auto;
    }

    /* CÄƒn chá»‰nh láº¡i header (tiÃªu Ä‘á» vÃ  nÃºt tab) */
    body.landscape-mode h1,
    body.landscape-mode .tabs {
      transform: rotate(0deg); /* Giá»¯ nguyÃªn hÆ°á»›ng chá»¯ */
      position: relative;
      z-index: 1000;
      margin: 0 auto;
      width: 100%;
      text-align: center;
    }

    /* Äáº£m báº£o nÃºt khÃ´ng bá»‹ mÃ©o */
    body.landscape-mode .btn {
      transform: rotate(0deg);
    }

  </style>
</head>
<body>
  <h1 id="judgeTitle">GiÃ¡m Ä‘á»‹nh sá»‘ 1</h1>

  <div class="tabs">
    <button class="tab-btn active" onclick="showTab('settingTab', this)">âš™ï¸ Thiáº¿t láº­p</button>
    <button class="tab-btn" onclick="showTab('scoreTab', this)">ğŸ“Š Äá»‘i khÃ¡ng</button>
    <button class="tab-btn" onclick="showTab('performanceTab', this)">ğŸ§‘â€ğŸ¤ Há»™i diá»…n</button>
  </div>

  <!-- Tab Äá»‘i khÃ¡ng -->
  <div id="scoreTab" class="tab-content">
    <div class="status" id="status"></div>
    <div class="container">
      <div class="col">
        <button class="btn red btn-large" onclick="sendScore('red', 'punch', this)">ğŸ”´ +1</button>
        <button class="btn red" onclick="sendScore('red', 'kick', this)">ğŸ”´ +2</button>
      </div>
      <div class="col">
        <button class="btn blue btn-large" onclick="sendScore('blue', 'punch', this)">ğŸ”µ +1</button>
        <button class="btn blue" onclick="sendScore('blue', 'kick', this)">ğŸ”µ +2</button>
      </div>
    </div>
  </div>

  <!-- Tab Thiáº¿t láº­p -->
  <div id="settingTab" class="tab-content active">
    <div class="setting-box">

      <label>ğŸ”¢ Nháº­p sá»‘ giÃ¡m Ä‘á»‹nh (1-5):</label>
      <input type="number" id="judgeId" min="1" max="5" value="1">

      <button class="save-btn" onclick="applySettings()">ğŸ’¾ XÃC NHáº¬N CÃ€I Äáº¶T</button>
      <div class="status" id="settingStatus"></div>
    </div>
    <div style="margin-top: 30px; text-align: center;">
      <button class="btn" style="background: orange; color: white; margin-right: 40px;" onclick="showTabDirect('performanceTab')">ğŸ§‘â€ğŸ¤ Há»˜I DIá»„N</button>
      <button class="btn" style="background: teal; color: white; margin-left: 40px;" onclick="showTabDirect('scoreTab')">âš”ï¸ Äá»I KHÃNG</button>
    </div>
  </div>
  <!-- Tab Há»™i diá»…n -->
  <div id="performanceTab" class="tab-content">
    <h2>ğŸ¯ Cháº¥m Ä‘iá»ƒm Há»™i diá»…n</h2>

    <p>ğŸ‘¤ GiÃ¡m Ä‘á»‹nh sá»‘: <strong id="judgeLabel">1</strong></p>

    <div id="perfDisplay" style="font-size: 80px; margin: 20px;">0</div>

    <!-- KHUNG BÃ€N PHÃM -->
    <div class="number-pad-container">
      <div class="number-grid">
        <button class="btn number" onclick="appendDigit(1)">1</button>
        <button class="btn number" onclick="appendDigit(2)">2</button>
        <button class="btn number" onclick="appendDigit(3)">3</button>
        <button class="btn number" onclick="appendDigit(4)">4</button>
        <button class="btn number" onclick="appendDigit(5)">5</button>
        <button class="btn number" onclick="appendDigit(6)">6</button>
        <button class="btn number" onclick="appendDigit(7)">7</button>
        <button class="btn number" onclick="appendDigit(8)">8</button>
        <button class="btn number" onclick="appendDigit(9)">9</button>
        <button class="btn number" onclick="clearDigit()">âŒ«</button>
        <button class="btn number" onclick="appendDigit(0)">0</button>
        <button id="submitPerfBtn" class="btn number green" onclick="submitPerfScore()">âœ…</button>
      </div>
    </div>

    <!-- THÃ”NG BÃO TRáº NG THÃI -->
    <div class="status" id="statusPerf"></div>
  </div>
  <script>
      const API_URL = "https://giamthiwellspring.site/api/send";  
      let serverIP = "INTERNET"; // khÃ´ng cÃ²n dÃ¹ng
      let judgeId = 1;
      let sanId = 1;   // <<< THÃŠM
      let isConfigured = false;

      // Äá»ŒC SÃ‚N Tá»ª URL
      const params = new URLSearchParams(window.location.search);
      sanId = parseInt(params.get("san")) || 1;


      function showTab(tabId, buttonElement) {
        // Náº¿u lÃ  tab Äá»‘i khÃ¡ng hoáº·c Há»™i diá»…n thÃ¬ kiá»ƒm tra cÃ i Ä‘áº·t
        if ((tabId === "scoreTab" || tabId === "performanceTab") && !checkAndApplySettings()) {
          // Náº¿u khÃ´ng Ä‘á»§ thÃ´ng tin thÃ¬ quay láº¡i tab Thiáº¿t láº­p
          document.getElementById("settingStatus").textContent = "âš ï¸ Vui lÃ²ng nháº­p Ä‘Ãºng IP vÃ  sá»‘ giÃ¡m Ä‘á»‹nh (1-5) trÆ°á»›c khi sá»­ dá»¥ng";
          showTabDirect("settingTab");
          return;
        }
        
        document.querySelectorAll(".tab-content").forEach(tab => tab.classList.remove("active"));
        document.querySelectorAll(".tab-btn").forEach(btn => btn.classList.remove("active"));
        document.getElementById(tabId).classList.add("active");
        buttonElement.classList.add("active");

        // Xoay toÃ n bá»™ trang náº¿u lÃ  tab Äá»‘i khÃ¡ng
        if (tabId === "scoreTab") {
          document.body.classList.add("landscape-mode");
        } else {
          document.body.classList.remove("landscape-mode");
        }
      }

      function checkAndApplySettings() {
        const judgeInput = parseInt(document.getElementById("judgeId").value);
        if (!isNaN(judgeInput) && judgeInput >= 1 && judgeInput <= 5) {
          judgeId = judgeInput;
          isConfigured = true;
          document.getElementById("judgeTitle").textContent =
            `SÃ‚N ${sanId} - GiÃ¡m Ä‘á»‹nh sá»‘ ${judgeId}`;
          document.getElementById("judgeLabel").textContent = judgeId;
          return true;
        }
        return false;
      }


      function applySettings() {
        const judgeInput = parseInt(document.getElementById("judgeId").value);

        if (isNaN(judgeInput) || judgeInput < 1 || judgeInput > 5) {
          document.getElementById("settingStatus").textContent =
            "âŒ Vui lÃ²ng nháº­p sá»‘ giÃ¡m Ä‘á»‹nh (1-5)";
          isConfigured = false;
          return;
        }

        judgeId = judgeInput;
        isConfigured = true;

        document.getElementById("judgeTitle").textContent =
          `SÃ‚N ${sanId} - GiÃ¡m Ä‘á»‹nh sá»‘ ${judgeId}`;
        document.getElementById("judgeLabel").textContent = judgeId;
        document.getElementById("settingStatus").textContent =
          `âœ… GiÃ¡m Ä‘á»‹nh sá»‘ ${judgeId}`;

        localStorage.setItem("lastJudgeId", judgeId.toString());
      }

      let perfCurrent = "";

      function appendDigit(d) {
        if (perfCurrent.length >= 2) {
          // Náº¿u Ä‘Ã£ 2 chá»¯ sá»‘, bá» chá»¯ sá»‘ Ä‘áº§u tiÃªn rá»“i thÃªm sá»‘ má»›i
          perfCurrent = perfCurrent.slice(1) + d.toString();
        } else {
          perfCurrent += d.toString();
        }
        document.getElementById("perfDisplay").textContent = perfCurrent;
      }

      function clearDigit() {
        perfCurrent = perfCurrent.slice(0, -1);
        document.getElementById("perfDisplay").textContent = perfCurrent || "0";
      }

      function submitPerfScore() {
        const status = document.getElementById("statusPerf");
        const score = parseInt(perfCurrent);
        const btn = document.getElementById("submitPerfBtn");

        if (!isConfigured) {
          status.textContent = "âš ï¸ Vui lÃ²ng thiáº¿t láº­p IP vÃ  GÄ.";
          return;
        }
        if (isNaN(score) || score < 0 || score > 99) {
          status.textContent = "âŒ Äiá»ƒm khÃ´ng há»£p lá»‡.";
          return;
        }

        // Hiá»‡u á»©ng nháº¥p nhÃ¡y + rung
        btn.classList.add("blink");

        if (window.AppInventor) {
          window.AppInventor.setWebViewString("vibrate");
        } else if (navigator.vibrate) {
          navigator.vibrate(100);
        }


        setTimeout(() => btn.classList.remove("blink"), 200);


        const payload = {
          type: "performance",
          san: sanId,          // <<< THÃŠM
          judge: judgeId,
          score: score
        };

        fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        })
          .then(response => {
            if (!response.ok) throw new Error();
            return response.text();
          })
          .then(text => {
            status.textContent = "âœ… Gá»­i Ä‘iá»ƒm thÃ nh cÃ´ng.";
            document.getElementById("status").textContent = "";
            // Giá»¯ nguyÃªn Ä‘iá»ƒm sau khi gá»­i thÃ nh cÃ´ng
            setTimeout(() => status.textContent = "", 2000);
          })
          .catch(() => {
            status.textContent = "âŒ KhÃ´ng gá»­i Ä‘Æ°á»£c Ä‘iá»ƒm.";
            status.style.color = "red";
            setTimeout(() => status.textContent = "", 3000);
          });
      }

      function sendScore(competitor, type, btn) {
        const status = document.getElementById("status");
        status.textContent = "";

        if (!isConfigured) {
          status.textContent = "âš ï¸ Vui lÃ²ng thiáº¿t láº­p GÄ trÆ°á»›c khi cháº¥m Ä‘iá»ƒm.";
          return;
        }

        // NhÃ¡y nÃºt
        btn.classList.add("blink");

        // Rung
        if (window.AppInventor) {
          window.AppInventor.setWebViewString("vibrate");
        } else if (navigator.vibrate) {
          navigator.vibrate(100);
        }

        setTimeout(() => btn.classList.remove("blink"), 200);

        fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            type: "combat",
            san: sanId,          // <<< THÃŠM
            judge: judgeId,
            team: competitor,
            action: type
          })
        })
          .then(res => {
            if (!res.ok) throw new Error();
            return res.json();
          })
          .then(() => {
            status.textContent = "âœ… Gá»­i Ä‘iá»ƒm thÃ nh cÃ´ng";
            status.style.color = "green";
            setTimeout(() => status.textContent = "", 2000);
          })
          .catch(() => {
            status.textContent = "âŒ KhÃ´ng gá»­i Ä‘Æ°á»£c Ä‘iá»ƒm.";
            status.style.color = "red";
            setTimeout(() => status.textContent = "", 3000);
          });
      }


      // HÃ m cáº­p nháº­t tráº¡ng thÃ¡i máº¡ng
      function updateNetworkStatus() {
        const status = document.getElementById("status");
        if (!navigator.onLine) {
          status.textContent = "âŒ Máº¥t káº¿t ná»‘i";
          status.style.color = "red";
        } else {
          // Náº¿u muá»‘n xÃ³a dÃ²ng máº¥t káº¿t ná»‘i khi cÃ³ máº¡ng trá»Ÿ láº¡i:
          status.textContent = "";
          status.style.color = "green";
        }
      }

      // Láº¯ng nghe sá»± kiá»‡n thay Ä‘á»•i máº¡ng
      window.addEventListener("online", updateNetworkStatus);
      window.addEventListener("offline", updateNetworkStatus);

      // Gá»i láº§n Ä‘áº§u khi trang má»Ÿ
      updateNetworkStatus();

      function showTabDirect(tabId) {
        // Náº¿u lÃ  tab Äá»‘i khÃ¡ng hoáº·c Há»™i diá»…n thÃ¬ kiá»ƒm tra cÃ i Ä‘áº·t
        if ((tabId === "scoreTab" || tabId === "performanceTab") && !checkAndApplySettings()) {
          // Náº¿u khÃ´ng Ä‘á»§ thÃ´ng tin thÃ¬ quay láº¡i tab Thiáº¿t láº­p
          document.getElementById("settingStatus").textContent = "âš ï¸ Vui lÃ²ng nháº­p Ä‘Ãºng IP vÃ  sá»‘ giÃ¡m Ä‘á»‹nh (1-5) trÆ°á»›c khi sá»­ dá»¥ng";
          tabId = "settingTab";
        }
        
        document.querySelectorAll(".tab-content").forEach(tab => tab.classList.remove("active"));
        document.getElementById(tabId).classList.add("active");

        // Xoay toÃ n bá»™ trang náº¿u lÃ  tab Äá»‘i khÃ¡ng
        if (tabId === "scoreTab") {
          document.body.classList.add("landscape-mode");
        } else {
          document.body.classList.remove("landscape-mode");
        }

        // Cáº­p nháº­t active tab button
        document.querySelectorAll(".tab-btn").forEach(btn => btn.classList.remove("active"));
        if (tabId === "settingTab") {
          document.querySelectorAll(".tab-btn")[0].classList.add("active");
        } else if (tabId === "scoreTab") {
          document.querySelectorAll(".tab-btn")[1].classList.add("active");
        } else if (tabId === "performanceTab") {
          document.querySelectorAll(".tab-btn")[2].classList.add("active");
        }
      }
  </script>  


</body>
</html>
